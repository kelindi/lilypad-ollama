#!/bin/bash

# Check if model name and version are provided
if [ "$#" -ne 2 ]; then
    echo "Usage: ./stack build <model_name> <model_version>"
    echo "Example: ./stack build llama2 7b"
    exit 1
fi

MODEL_NAME=$1
MODEL_VERSION=$2
IMAGE_NAME="lilypad-ollama-${MODEL_NAME}"

# Generate the README
./stack generate-readme "$MODEL_NAME" "$MODEL_VERSION"

# Build the Docker image
docker buildx build --platform linux/amd64 \
  --build-arg MODEL_NAME="$MODEL_NAME" \
  --build-arg MODEL_VERSION="$MODEL_VERSION" \
  -t "$IMAGE_NAME:latest" .

# Generate the module template with the correct image name
sed "s/\${MODEL_NAME}/$MODEL_NAME/g" lilypad_module.json.tmpl > "lilypad_module_${MODEL_NAME}.json"

echo "Build complete! You can now:"
echo "1. Tag the image: docker tag $IMAGE_NAME:latest <your-dockerhub-username>/$IMAGE_NAME:latest"
echo "2. Push to Docker Hub: docker push <your-dockerhub-username>/$IMAGE_NAME:latest" 