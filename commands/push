#!/bin/bash

if [ "$#" -lt 1 ] || [ "$#" -gt 2 ]; then
    echo "Usage: ./stack push <image_name> [tag]"
    echo "Example: ./stack push lilypad-ollama-llama2-7b:latest"
    echo "Example with tag: ./stack push lilypad-ollama-llama2-7b:latest v1.0.0"
    exit 1
fi

# Source configuration
CONFIG_FILE="$HOME/.lilypad-ollama/config"
if [ ! -f "$CONFIG_FILE" ]; then
    echo "Please configure your Docker Hub username first:"
    echo "./stack configure <dockerhub-username>"
    exit 1
fi
source "$CONFIG_FILE"

# Check if template exists
if [ ! -f "lilypad_module.json.tmpl" ]; then
    echo "Error: lilypad_module.json.tmpl not found!"
    exit 1
fi

IMAGE_NAME=$1
TAG=${2:-latest}  # Use provided tag or default to 'latest'

# Remove the :latest suffix if present from IMAGE_NAME
BASE_IMAGE_NAME=${IMAGE_NAME%:latest}

# Extract the model name from the image name (everything after lilypad-ollama-)
MODEL_NAME=${BASE_IMAGE_NAME#lilypad-ollama-}

# Create template file name from image name
template_file="${BASE_IMAGE_NAME}.json.tmpl"

# Create the full Docker image paths
DOCKER_IMAGE="${DOCKER_HUB_USERNAME}/${BASE_IMAGE_NAME}:${TAG}"
DOCKER_IMAGE_LATEST="${DOCKER_HUB_USERNAME}/${BASE_IMAGE_NAME}:latest"

echo "Creating new template file: $template_file"
cp "lilypad_module.json.tmpl" "$template_file"

# Substitute variables in the new template
sed -i '' "s|\${MODEL_NAME}|${MODEL_NAME}|g" "$template_file"
sed -i '' "s|\${DOCKER_HUB_USERNAME}|${DOCKER_HUB_USERNAME}|g" "$template_file"
sed -i '' "s|\${TAG}|${TAG}|g" "$template_file"

echo "Pushing $IMAGE_NAME to Docker Hub as:"
echo "  - $DOCKER_IMAGE"
echo "  - $DOCKER_IMAGE_LATEST"

# Tag the image with both the specified tag and latest
docker tag "$IMAGE_NAME" "$DOCKER_IMAGE"
docker tag "$IMAGE_NAME" "$DOCKER_IMAGE_LATEST"

# Push both tags
docker push "$DOCKER_IMAGE"
docker push "$DOCKER_IMAGE_LATEST"

echo "Generated new template file: $template_file"
